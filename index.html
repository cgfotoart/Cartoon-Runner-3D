<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Cartoon Runner 3D ‚Äì Demo v2</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#0f1116;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  #hud{position:fixed;top:10px;left:10px;color:#ffd54a;text-shadow:0 1px 2px #000;font-weight:700;font-size:16px;z-index:5}
  #hud .row{margin-bottom:6px;color:#fff}
  #hud button{background:#ffd54a;border:0;border-radius:8px;padding:6px 10px;font-weight:800;margin-right:8px;cursor:pointer}
  #hint{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);color:#fff;background:#0009;padding:10px 14px;border-radius:10px;z-index:4;display:none}
  #mobile{position:fixed;inset:auto 0 0 0;display:none;justify-content:space-between;padding:10px;z-index:6;pointer-events:none}
  .pad{pointer-events:auto;display:grid;grid-template-columns:repeat(3,64px);grid-template-rows:repeat(2,64px);gap:10px;background:#0006;border:1px solid #fff3;border-radius:12px;padding:10px}
  .pad button{width:64px;height:64px;border:0;border-radius:12px;background:#ffd54a;font-weight:900}
  .wide{grid-column:1/4}
  #minimap{position:fixed;right:10px;top:10px;width:140px;height:140px;background:#000a;border:1px solid #fff3;border-radius:8px;z-index:7}
</style>
</head>
<body>
<div id="hud">
  <div class="row">üç© Donuts: <span id="score">0</span> / 10</div>
  <div class="row">‚ù§Ô∏è HP: <span id="hp">3</span> &nbsp; ‚è±Ô∏è Zeit: <span id="time">0.0</span>s</div>
  <div class="row">
    <button id="perf">Leistung: Hoch</button>
    <button id="reset">Neu starten (R)</button>
  </div>
  <div class="row">Tasten: WASD bewegen, Maus Umschauen (klicken), SPACE springen</div>
</div>
<canvas id="minimap"></canvas>
<div id="hint">Tippe, um zu starten. Ziehe zum Umschauen. Buttons unten f√ºr Bewegung.</div>

<div id="mobile" aria-hidden="true">
  <div class="pad">
    <button id="ml">‚Üê</button><div></div><button id="mr">‚Üí</button>
    <button id="jump" class="wide">SPRING</button>
  </div>
  <div class="pad">
    <button id="mu">‚Üë</button><div></div><button id="md">‚Üì</button>
    <button id="lock" class="wide">LOOK</button>
  </div>
</div>

<canvas id="c"></canvas>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { PointerLockControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/PointerLockControls.js';

// --- Renderer / Scene / Camera ---
const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = true;
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 220);
camera.position.set(0, 1.7, 5);

// Lights
const hemi = new THREE.HemisphereLight(0xffffff, 0x334466, 0.8);
scene.add(hemi);
const sun = new THREE.DirectionalLight(0xffffff, 1.0);
sun.position.set(5, 12, 3);
sun.castShadow = true;
sun.shadow.mapSize.set(1024,1024);
scene.add(sun);

// Ground
const groundGeo = new THREE.PlaneGeometry(240, 240);
const groundMat = new THREE.MeshPhongMaterial({color:0x6ab04c});
const ground = new THREE.Mesh(groundGeo, groundMat);
ground.rotation.x = -Math.PI/2;
ground.receiveShadow = true;
scene.add(ground);

// Buildings
function box(w,h,d,color,x,z){
  const m = new THREE.MeshPhongMaterial({color});
  const g = new THREE.BoxGeometry(w,h,d);
  const mesh = new THREE.Mesh(g,m);
  mesh.position.set(x, h/2, z);
  mesh.castShadow = mesh.receiveShadow = true;
  scene.add(mesh);
  return mesh;
}
for(let i=0;i<12;i++){
  box(6, THREE.MathUtils.randFloat(3,6), 6, 0xffe16b, -50 + i*8, -24);
  box(6, THREE.MathUtils.randFloat(3,6), 6, 0xff94c2, -50 + i*8, 24);
}

// Platforms
const platformMat = new THREE.MeshPhongMaterial({color:0x3a3a3a});
const platforms = [];
function platform(x,y,z,w=8,d=8){
  const g = new THREE.BoxGeometry(w,0.8,d);
  const mesh = new THREE.Mesh(g,platformMat);
  mesh.position.set(x,y,z);
  mesh.castShadow = mesh.receiveShadow = true;
  scene.add(mesh); platforms.push(mesh);
  return mesh;
}
platform(0, 2.5, 0, 8, 8);
platform(8, 4.5, -4, 8, 8);

// Moving platform (left-right)
const mover = platform(18, 6.5, -6, 8, 8);
mover.userData.move = {axis:'x', base:18, amp:6, speed:1.2};

// Elevator (up-down)
const lift = platform(30, 3, -2, 8, 8);
lift.userData.move = {axis:'y', base:3, amp:4, speed:0.9};

// High platform chain to goal
platform(42, 7.5, 0, 8, 8);

// Goal
const goal = box(2,1.2,1,0xff6b6b, 46, 0);

// Donuts
const donuts = [];
const donutMat = new THREE.MeshPhongMaterial({color:0xff94c2});
function donut(x,y,z){
  const g = new THREE.TorusGeometry(0.4, 0.16, 12, 24);
  const mesh = new THREE.Mesh(g, donutMat);
  mesh.position.set(x,y,z);
  mesh.castShadow = true;
  scene.add(mesh); donuts.push(mesh);
}
[[0,3.4,0],[8,5.4,-4],[18,7.4,-6],[30,5.4,-2],[42,8.6,0],
 [4,3.2,2],[12,4.0,-6],[22,7.2,-8],[34,6.2,-2],[40,8.2,1.5]
].forEach(p=>donut(...p));

// Enemies (simple patrol cubes)
const enemies = [];
function enemy(x,z,range=4,speed=1.5){
  const g = new THREE.BoxGeometry(1,1,1);
  const m = new THREE.MeshPhongMaterial({color:0xff5555});
  const e = new THREE.Mesh(g,m);
  e.castShadow = true; e.position.set(x,0.5,z);
  e.userData = {baseX:x, baseZ:z, t:Math.random()*10, range, speed};
  scene.add(e); enemies.push(e);
}
enemy(10, 0, 4, 1.2);
enemy(26, -4, 5, 1.6);
enemy(38, 0, 3.5, 1.4);

// Controls / Physics
const controls = new PointerLockControls(camera, document.body);
document.body.addEventListener('click', () => { if (!isMobile()) controls.lock(); });
const velocity = new THREE.Vector3();
const GRAVITY = 20, SPEED = 7, JUMP = 7;
let canJump = false, onGround = false, hp = 3, invuln = 0;

// Raycaster
const raycaster = new THREE.Raycaster();
raycaster.far = 2;

function aabbIntersect(p, b, hw=0.3, hh=1.7, hd=0.3){
  const minA = new THREE.Vector3(p.x - hw, p.y - hh, p.z - hd);
  const maxA = new THREE.Vector3(p.x + hw, p.y + hh, p.z + hd);
  const bb = new THREE.Box3().setFromObject(b);
  return bb.intersectsBox(new THREE.Box3(minA, maxA));
}

// Input
const keys = { w:false, a:false, s:false, d:false, space:false };
document.addEventListener('keydown',(e)=>{
  if(e.code==='KeyW') keys.w=true;
  if(e.code==='KeyA') keys.a=true;
  if(e.code==='KeyS') keys.s=true;
  if(e.code==='KeyD') keys.d=true;
  if(e.code==='Space'){ keys.space=true; e.preventDefault(); }
  if(e.code==='KeyR') location.reload();
});
document.addEventListener('keyup',(e)=>{
  if(e.code==='KeyW') keys.w=false;
  if(e.code==='KeyA') keys.a=false;
  if(e.code==='KeyS') keys.s=false;
  if(e.code==='KeyD') keys.d=false;
  if(e.code==='Space') keys.space=false;
});

// Mobile
const mobile = {ml:false, mr:false, mu:false, md:false, jump:false};
function bindBtn(id, prop){
  const el = document.getElementById(id);
  el.addEventListener('touchstart',(e)=>{ mobile[prop]=true; e.preventDefault(); },{passive:false});
  el.addEventListener('touchend',()=>{ mobile[prop]=false; });
}
['ml','mr','mu','md','jump'].forEach(id=>bindBtn(id,id));
document.getElementById('lock').addEventListener('touchstart', ()=>{ document.getElementById('hint').style.display='none'; });

// HUD
const ui = {
  score: document.getElementById('score'),
  hp: document.getElementById('hp'),
  time: document.getElementById('time'),
  hint: document.getElementById('hint'),
  mobile: document.getElementById('mobile'),
  perf: document.getElementById('perf')
};
let score = 0, elapsed = 0, lowPerf=false;
ui.hp.textContent = hp.toString();
ui.perf.onclick = () => {
  lowPerf = !lowPerf;
  renderer.setPixelRatio(lowPerf ? 1 : Math.min(devicePixelRatio, 2));
  renderer.shadowMap.enabled = !lowPerf;
  sun.castShadow = !lowPerf;
  ui.perf.textContent = 'Leistung: ' + (lowPerf ? 'Niedrig' : 'Hoch');
};

function isMobile(){ return /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent); }
if(isMobile()){ ui.hint.style.display='block'; ui.mobile.style.display='flex'; }

// Resize
window.addEventListener('resize', ()=>{
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

// Minimap (2D overlay)
const map = document.getElementById('minimap');
const mctx = map.getContext('2d');
const MAP_SCALE = 2.4; // world x/z scaled into ~120px
function drawMinimap(){
  const w = map.width = map.clientWidth;
  const h = map.height = map.clientHeight;
  mctx.clearRect(0,0,w,h);
  // bg grid
  mctx.fillStyle='#0b0d12'; mctx.fillRect(0,0,w,h);
  mctx.strokeStyle='#ffffff30'; mctx.strokeRect(0,0,w,h);
  // helper to convert world x,z -> map u,v (centered)
  function toMap(x,z){
    const u = w/2 + x*MAP_SCALE*0.5;
    const v = h/2 + z*MAP_SCALE*0.5;
    return [u,v];
  }
  // platforms
  mctx.fillStyle='#ffd54a55';
  platforms.forEach(p=>{
    const bb = new THREE.Box3().setFromObject(p);
    const [u1,v1] = toMap(bb.min.x, bb.min.z);
    const [u2,v2] = toMap(bb.max.x, bb.max.z);
    mctx.fillRect(Math.min(u1,u2), Math.min(v1,v2), Math.abs(u2-u1), Math.abs(v2-v1));
  });
  // enemies
  mctx.fillStyle='#ff5555';
  enemies.forEach(e=>{
    const [u,v] = toMap(e.position.x, e.position.z);
    mctx.beginPath(); mctx.arc(u,v,4,0,Math.PI*2); mctx.fill();
  });
  // donuts
  mctx.fillStyle='#ff94c2';
  donuts.forEach(d=>{
    const [u,v] = toMap(d.position.x, d.position.z);
    mctx.beginPath(); mctx.arc(u,v,3,0,Math.PI*2); mctx.fill();
  });
  // player
  mctx.fillStyle='#6cf';
  const [pu,pv] = toMap(camera.position.x, camera.position.z);
  mctx.beginPath(); mctx.arc(pu,pv,5,0,Math.PI*2); mctx.fill();
}

// --- Game Loop ---
const clock = new THREE.Clock();
function animate(){
  const dt = Math.min(0.05, clock.getDelta());
  elapsed += dt; ui.time.textContent = elapsed.toFixed(1);

  // Donut spin
  donuts.forEach((d,i)=>{ d.rotation.y += dt*(0.5 + 0.2*i); });

  // Moving platforms
  [mover, lift].forEach(p=>{
    const m = p.userData.move; if(!m) return;
    const t = performance.now()*0.001*m.speed;
    if(m.axis==='x') p.position.x = m.base + Math.sin(t)*m.amp;
    if(m.axis==='y') p.position.y = m.base + (Math.sin(t)*0.5+0.5)*m.amp; // 0..amp
  });

  // Enemies patrol
  enemies.forEach(e=>{
    e.userData.t += dt * e.userData.speed;
    e.position.x = e.userData.baseX + Math.sin(e.userData.t)*e.userData.range;
    e.rotation.y += dt*2;
  });

  // Movement
  const forward = (keys.w || mobile.mu) ? 1 : (keys.s || mobile.md) ? -1 : 0;
  const right = (keys.d || mobile.mr) ? 1 : (keys.a || mobile.ml) ? -1 : 0;
  if (controls.isLocked || isMobile()){
    if(!isMobile()){
      controls.moveRight(right * SPEED * dt);
      controls.moveForward(forward * SPEED * dt);
    } else {
      const yaw = camera.rotation.y;
      const fwd = new THREE.Vector3(Math.sin(yaw), 0, -Math.cos(yaw));
      const rightv = new THREE.Vector3().crossVectors(fwd, new THREE.Vector3(0,1,0)).negate();
      camera.position.addScaledVector(fwd, forward * SPEED * dt);
      camera.position.addScaledVector(rightv, right * SPEED * dt);
    }
  }

  // Gravity
  velocity.y -= GRAVITY * dt;
  camera.position.y += velocity.y * dt;

  // Ground / platform check
  raycaster.set(new THREE.Vector3(camera.position.x, camera.position.y, camera.position.z), new THREE.Vector3(0,-1,0));
  const intersects = raycaster.intersectObjects([ground, ...platforms], false);
  const dist = (intersects.length>0) ? intersects[0].distance : Infinity;
  onGround = dist < 1.8;
  if(onGround && velocity.y < 0){
    velocity.y = 0; camera.position.y = intersects[0].point.y + 1.7; canJump = true;
    // If standing on moving platform, move along with it slightly
    const obj = intersects[0].object;
    if(obj.userData.move && obj.userData.move.axis==='x'){
      const m = obj.userData.move;
      const vel = Math.cos(performance.now()*0.001*m.speed)*m.amp*m.speed*0.02;
      camera.position.x += vel;
    }
  }
  if((keys.space || mobile.jump) && canJump){ velocity.y = JUMP; canJump = false; }

  // Collide with platforms sides
  platforms.forEach(p=>{
    if(aabbIntersect(camera.position, p)){
      const bb = new THREE.Box3().setFromObject(p);
      const px = camera.position.x, py = camera.position.y, pz = camera.position.z;
      const dx1 = bb.max.x - (px - 0.3);
      const dx2 = (px + 0.3) - bb.min.x;
      const dz1 = bb.max.z - (pz - 0.3);
      const dz2 = (pz + 0.3) - bb.min.z;
      const dy1 = bb.max.y - (py - 1.7);
      const dy2 = (py + 0.1) - bb.min.y;
      const minPush = Math.min(dx1, dx2, dz1, dz2, dy1, dy2);
      if(minPush === dx1) camera.position.x = bb.max.x + 0.31;
      else if(minPush === dx2) camera.position.x = bb.min.x - 0.31;
      else if(minPush === dz1) camera.position.z = bb.max.z + 0.31;
      else if(minPush === dz2) camera.position.z = bb.min.z - 0.31;
      else if(minPush === dy1){ camera.position.y = bb.max.y + 1.71; velocity.y = 0; canJump = true; }
      else if(minPush === dy2){ camera.position.y = bb.min.y - 0.11; velocity.y = Math.min(velocity.y, 0); }
    }
  });

  // Enemy collisions (damage with short invulnerability + knockback)
  if(invuln>0) invuln -= dt;
  enemies.forEach(e=>{
    if(aabbIntersect(camera.position, e) && invuln<=0){
      hp--; invuln = 1.2; ui.hp.textContent = hp.toString();
      // knockback
      const dir = new THREE.Vector3().subVectors(camera.position, e.position).setY(0).normalize();
      camera.position.addScaledVector(dir, 1.2);
      velocity.y = Math.max(velocity.y, 4);
      if(hp<=0){ showBanner('Game Over üí•'); }
    }
  });

  // Collect donuts
  for(let i=donuts.length-1;i>=0;i--){
    const d = donuts[i];
    if(d.position.distanceTo(camera.position) < 1.2){
      scene.remove(d); donuts.splice(i,1); score++; ui.score.textContent = score.toString();
    }
  }

  // Win check
  if(aabbIntersect(camera.position, goal)){
    showBanner('Geschafft! üç©');
  }

  renderer.render(scene, camera);
  drawMinimap();
  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);

// Banner + restart
function showBanner(msg){
  const div = document.createElement('div');
  div.textContent = msg + ' ‚Äì Tippe R zum Neustart';
  Object.assign(div.style, {position:'fixed',left:'50%',top:'50%',transform:'translate(-50%,-50%)',
    background:'#0009',color:'#ffd54a',padding:'12px 16px',borderRadius:'10px',zIndex:10,fontWeight:'900'});
  document.body.appendChild(div);
  window.addEventListener('keydown',(e)=>{ if(e.code==='KeyR') location.reload(); }, {once:true});
}

// Helpers
function isMobile(){ return /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent); }
if(isMobile()){ ui.hint.style.display='block'; document.getElementById('mobile').style.display='flex'; }

// Reset button
document.getElementById('reset').onclick = ()=> location.reload();
</script>
</body>
</html>
